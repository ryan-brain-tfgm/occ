
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Enhanced Map UI with Waze Alerts</title>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    font-family: 'Merriweather', serif;
  }

  #map {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
  }

  .overlay {
    position: absolute;
    z-index: 1000;
    color: #fff;
  }

  .top-bar {
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    background: rgba(0, 0, 0, 0.6);
    padding: 10px;
    border-radius: 8px;
  }

  .info-box {
    bottom: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.9);
    color: #000;
    padding: 10px;
    border-radius: 8px;
    max-width: 300px;
  }

  input, button {
    padding: 8px;
    border-radius: 4px;
    border: none;
    font-size: 14px;
  }

  button {
    background-color: #FFCC33;
    font-weight: bold;
    cursor: pointer;
  }

  .route-chip {
    display: inline-block;
    background-color: white;
    color: #3399FF;
    border-radius: 999px;
    padding: 4px 10px;
    margin: 2px;
    font-size: 0.85em;
    font-weight: bold;
  }
</style>
</head>
<body>
<div id="map"></div>
<div class="overlay top-bar">
  <input id="coordInput" placeholder="Paste coordinates"/>
  <button onclick="generateLinks()">Go üöÄ</button>
  <button onclick="openAllLinks()">üåê Open All</button>
  <button onclick="copyGoogleMapsLink()">ü¶Ö Copy</button>
</div>
<div class="overlay info-box">
  <h3>üìç Location Info</h3>
  <p><strong>Street:</strong> <span id="streetName">-</span></p>
  <p><strong>LA:</strong> <span id="cityName">-</span></p>
  <p><strong>Postcode:</strong> <span id="postcode">-</span></p>
  <h4>üöå Bus Routes</h4>
  <div id="busRoutes">Loading...</div>
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let map = L.map('map').setView([53.48, -2.24], 13);
  L.tileLayer('https://tile.thunderforest.com/transport-dark/{z}/{x}/{y}.png?apikey=ec4c98ec4e394899a63ccecdf9712e54', {
    attribution: '¬© Thunderforest, ¬© OpenStreetMap contributors'
  }).addTo(map);

  let marker;
  const accidentIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/1933/1933005.png',
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  });

  function extractCoordinates(input) {
    const match = input.match(/(-?\d+(?:\.\d+)?)[^\d.-]*(-?\d+(?:\.\d+)?)/);
    return match ? [parseFloat(match[1]), parseFloat(match[2])] : null;
  }

  function generateLinks() {
    const input = document.getElementById("coordInput").value;
    const coords = extractCoordinates(input);
    if (!coords) return alert("Invalid coordinates");

    const [lat, lon] = coords;
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lon], { draggable: true }).addTo(map);
    marker.on('dragend', function (e) {
      const position = marker.getLatLng();
      document.getElementById("coordInput").value = position.lat.toFixed(6) + ", " + position.lng.toFixed(6);
      generateLinks();
    });
    map.setView([lat, lon], 16);

    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
      .then(res => res.json())
      .then(data => {
        const address = data.address || {};
        document.getElementById("streetName").textContent = address.road || "-";
        document.getElementById("cityName").textContent = address.city || address.town || address.village || "-";
        document.getElementById("postcode").textContent = address.postcode || "-";
      });

    fetchBusRoutes(lat, lon);
  }

  function fetchBusRoutes(lat, lon) {
    const query = `[out:json];relation["route"="bus"](around:50,${lat},${lon});out tags;`;
    fetch("https://overpass-api.de/api/interpreter", {
      method: "POST",
      body: query
    })
    .then(res => res.json())
    .then(data => {
      const routes = new Set();
      data.elements.forEach(el => {
        if (el.tags?.ref) routes.add(el.tags.ref);
      });
      const container = document.getElementById("busRoutes");
      container.innerHTML = "";
      if (routes.size === 0) {
        container.textContent = "None found";
      } else {
        Array.from(routes).sort().forEach(route => {
          const chip = document.createElement("span");
          chip.className = "route-chip";
          chip.textContent = route;
          container.appendChild(chip);
        });
      }
    })
    .catch(() => {
      document.getElementById("busRoutes").textContent = "Error fetching";
    });
  }

  function openAllLinks() {
    // Placeholder for opening links
  }

  function copyGoogleMapsLink() {
    const input = document.getElementById("coordInput").value;
    const coords = extractCoordinates(input);
    if (!coords) return alert("Invalid input");
    const [lat, lon] = coords;
    const url = `https://www.google.com/maps/@${lat},${lon},316m/`;
    navigator.clipboard.writeText(url).then(() => alert("Copied!"));
  }

  function loadWazeAlerts() {
    fetch("https://corsproxy.io/?url=https://www.waze.com/row-partnerhub-api/partners/11867436614/waze-feeds/4e8ef399-d6b9-4338-9840-7c2beacd235b?format=1")
      .then(res => res.json())
      .then(data => {
        if (!data.alerts) return;
        data.alerts.forEach(alert => {
          if (alert.type === "ACCIDENT" && alert.location) {
            const lat = alert.location.y;
            const lon = alert.location.x;
            const description = alert.description || "Accident reported";
            L.marker([lat, lon], { icon: accidentIcon })
              .addTo(map)
              .bindPopup("üöß " + description);
          }
        });
      })
      .catch(err => {
        console.error("Failed to load Waze alerts:", err);
      });
  }

  loadWazeAlerts();
  setInterval(loadWazeAlerts, 5 * 60 * 1000);

  map.on('click', function(e) {
    const lat = e.latlng.lat.toFixed(6);
    const lon = e.latlng.lng.toFixed(6);
    const input = document.getElementById("coordInput");
    input.value = lat + ", " + lon;
    generateLinks();
  });
</script>
</body>
</html>

